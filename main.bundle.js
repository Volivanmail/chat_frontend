/*! For license information please see main.bundle.js.LICENSE.txt */
(()=>{"use strict";class e{constructor(e){this.name=e}create(){const e=document.createElement("form");e.classList="popup",e.textContent=this.name,document.body.appendChild(e);const t=document.createElement("input");t.required=!0,t.type="text",e.appendChild(t);const n=document.createElement("button");return n.textContent="Продолжить",e.appendChild(n),{popup:e,submit:n,userName:t}}}const t={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let n;const o=new Uint8Array(16);function r(){if(!n&&(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!n))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(o)}const s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).slice(1));const i=function(e,n,o){if(t.randomUUID&&!n&&!e)return t.randomUUID();const i=(e=e||{}).random||(e.rng||r)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,n){o=o||0;for(let e=0;e<16;++e)n[o+e]=i[e];return n}return function(e,t=0){return(s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]).toLowerCase()}(i)};var c=function(e,t){return c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},c(e,t)};function a(e,t){function n(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function u(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,s=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(o=s.next()).done;)i.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return i}var l=function(e,t){this.target=t,this.type=e},d=function(e){function t(t,n){var o=e.call(this,"error",n)||this;return o.message=t.message,o.error=t,o}return a(t,e),t}(l),h=function(e){function t(t,n,o){void 0===t&&(t=1e3),void 0===n&&(n="");var r=e.call(this,"close",o)||this;return r.wasClean=!0,r.code=t,r.reason=n,r}return a(t,e),t}(l),p=function(){if("undefined"!=typeof WebSocket)return WebSocket},f={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+4e3*Math.random(),minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1};const m=function(){function e(e,t,n){var o=this;void 0===n&&(n={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(e){o._debug("open event");var t=o._options.minUptime,n=void 0===t?f.minUptime:t;clearTimeout(o._connectTimeout),o._uptimeTimeout=setTimeout((function(){return o._acceptOpen()}),n),o._ws.binaryType=o._binaryType,o._messageQueue.forEach((function(e){return o._ws.send(e)})),o._messageQueue=[],o.onopen&&o.onopen(e),o._listeners.open.forEach((function(t){return o._callEventListener(e,t)}))},this._handleMessage=function(e){o._debug("message event"),o.onmessage&&o.onmessage(e),o._listeners.message.forEach((function(t){return o._callEventListener(e,t)}))},this._handleError=function(e){o._debug("error event",e.message),o._disconnect(void 0,"TIMEOUT"===e.message?"timeout":void 0),o.onerror&&o.onerror(e),o._debug("exec error listeners"),o._listeners.error.forEach((function(t){return o._callEventListener(e,t)})),o._connect()},this._handleClose=function(e){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(e),o._listeners.close.forEach((function(t){return o._callEventListener(e,t)}))},this._url=e,this._protocols=t,this._options=n,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(e,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CONNECTING",{get:function(){return e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"OPEN",{get:function(){return e.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSING",{get:function(){return e.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"CLOSED",{get:function(){return e.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bufferedAmount",{get:function(){return this._messageQueue.reduce((function(e,t){return"string"==typeof t?e+=t.length:t instanceof Blob?e+=t.size:e+=t.byteLength,e}),0)+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?e.CLOSED:e.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),e.prototype.close=function(e,t){void 0===e&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),this._ws?this._ws.readyState!==this.CLOSED?this._ws.close(e,t):this._debug("close: already closed"):this._debug("close enqueued: no ws instance")},e.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,this._ws&&this._ws.readyState!==this.CLOSED?(this._disconnect(e,t),this._connect()):this._connect()},e.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,n=void 0===t?f.maxEnqueuedMessages:t;this._messageQueue.length<n&&(this._debug("enqueue",e),this._messageQueue.push(e))}},e.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},e.prototype.dispatchEvent=function(e){var t,n,o=this._listeners[e.type];if(o)try{for(var r=function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}(o),s=r.next();!s.done;s=r.next()){var i=s.value;this._callEventListener(e,i)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return!0},e.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((function(e){return e!==t})))},e.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(u(arguments[t]));return e}(["RWS>"],e))},e.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,n=void 0===t?f.reconnectionDelayGrowFactor:t,o=e.minReconnectionDelay,r=void 0===o?f.minReconnectionDelay:o,s=e.maxReconnectionDelay,i=void 0===s?f.maxReconnectionDelay:s,c=0;return this._retryCount>0&&(c=r*Math.pow(n,this._retryCount-1))>i&&(c=i),this._debug("next delay",c),c},e.prototype._wait=function(){var e=this;return new Promise((function(t){setTimeout(t,e._getNextDelay())}))},e.prototype._getNextUrl=function(e){if("string"==typeof e)return Promise.resolve(e);if("function"==typeof e){var t=e();if("string"==typeof t)return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},e.prototype._connect=function(){var e=this;if(!this._connectLock&&this._shouldReconnect){this._connectLock=!0;var t=this._options,n=t.maxRetries,o=void 0===n?f.maxRetries:n,r=t.connectionTimeout,s=void 0===r?f.connectionTimeout:r,i=t.WebSocket,c=void 0===i?p():i;if(this._retryCount>=o)this._debug("max retries reached",this._retryCount,">=",o);else{if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),void 0===(a=c)||!a||2!==a.CLOSING)throw Error("No valid WebSocket class provided");var a;this._wait().then((function(){return e._getNextUrl(e._url)})).then((function(t){e._closeCalled||(e._debug("connect",{url:t,protocols:e._protocols}),e._ws=e._protocols?new c(t,e._protocols):new c(t),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout((function(){return e._handleTimeout()}),s))}))}}},e.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new d(Error("TIMEOUT"),this))},e.prototype._disconnect=function(e,t){if(void 0===e&&(e=1e3),this._clearTimeouts(),this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new h(e,t,this))}catch(e){}}},e.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},e.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},e.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},e.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},e.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},e}();class _{constructor(e,t,n,o,r){this.id=e,this.user=t,this.date=n,this.text=o,this.you=r}view(){const e=document.createElement("div");e.id=this.id;const t=document.createElement("div");t.classList="messInfo";const n=document.createElement("div");let o;return n.classList="messText",this.you?(e.classList="myMess",t.classList.toggle("you"),o="You"):(e.classList="mess",o=this.user),t.textContent=`${o}, ${this.date}`,n.textContent=this.text,[t,n].forEach((t=>{e.appendChild(t)})),{newMess:e,id:this.id,user:this.user,date:this.date,text:this.text}}}class y{constructor(e,t,n){this.users=e,this.messages=t,this.currentUser=n}create(){const e=document.createElement("div");e.classList="chatWindow",document.body.appendChild(e);const t=document.createElement("div");t.classList="scrollBar",e.appendChild(t);const n=document.createElement("input");n.placeholder="Type your message here",n.classList="chatStr",t.appendChild(n),this.messages&&this.messages.forEach((e=>{const n=new _(e.id,e.user,e.date,e.text,!1);t.appendChild(n.view().newMess),document.querySelector(".scrollBar").lastElementChild.scrollIntoView({block:"end"})}));const o=document.createElement("div");o.classList="sideBar",document.body.appendChild(o);const r=document.createElement("ul");r.classList="usersList",this.users.forEach((e=>{const t=document.createElement("li");t.name=e,e===this.currentUser?(t.textContent="You",t.classList="you"):t.textContent=e,r.appendChild(t)})),o.appendChild(r)}}document.addEventListener("DOMContentLoaded",(()=>{!async function(){new Promise(((t,n)=>{const o=new e("Выберите псевдоним"),{popup:r,submit:s,userName:c}=o.create(),a=new WebSocket("wss://friday-chat.onrender.com/");a.onopen=()=>{console.log("---checking for initial data---"),a.send(JSON.stringify({type:"initialData",data:""}))},a.onmessage=e=>{const o=JSON.parse(e.data);if("initialData"===o.type){const e=o.data;s.addEventListener("click",(o=>{o.preventDefault();const s=c.value;localStorage.setItem("currentUser",s),!e.includes(s)&&s.length>1&&s.length<=10&&1===a.readyState?(a.send(JSON.stringify({type:"userEnter",data:s})),r.remove(),t((()=>function(){const e=new m("wss://friday-chat.onrender.com/"),t=localStorage.getItem("currentUser");window.addEventListener("beforeunload",(n=>{1!==e.readyState?(n.preventDefault(),n.returnValue="",console.log("Вы собираетесь перезарузить систему до загрузки данных, подождите пару секунд до появления надписи 'connection is open', а затем можете обновлять страницу. В противном случае произойдет серверный сбой")):e.send(JSON.stringify({type:"userOut",data:t}))})),e.send(JSON.stringify({type:"chatReq",data:""})),e.onopen=()=>{console.log("connection is open")},e.onmessage=n=>{const o=JSON.parse(n.data);if("chatReq"!==o.type||document.querySelector(".chatWindow")){if("currentUserList"===o.type){const e=document.querySelector(".usersList"),t=o.data.usersOnline;e&&(t.forEach((t=>{if(!Array.from(e.childNodes).map((e=>e.name)).includes(t)){const n=document.createElement("li");n.name=t,n.textContent=t,e.appendChild(n)}})),Array.from(e.childNodes).forEach((e=>{t.includes(e.name)||e.remove()})));const n=document.querySelector(".scrollBar"),r=o.data.messages;n&&r.forEach((e=>{if(!Array.from(n.childNodes).filter((e=>"INPUT"!==e.nodeName)).map((e=>e.id)).includes(e.id)){const t=new _(e.id,e.user,e.date,e.text,!1);n.appendChild(t.view().newMess),n.lastElementChild.scrollIntoView({block:"end"})}}))}}else{const{usersOnline:e}=o.data,{messages:n}=o.data;new y(e,n,t).create(),document.querySelector(".scrollBar").lastElementChild.scrollIntoView({block:"end"})}const r=document.querySelector(".chatStr");r&&r.addEventListener("change",(n=>{const o=new _(i(),t,function(e){function t(e){return e.length<2&&(e=`0${e}`),e}return`${t(String(e.getHours()))}:${t(String(e.getMinutes()))} ${t(String(e.getUTCDate()))}.${t(String(e.getUTCMonth()+1))}.${String(e.getFullYear())}`}(new Date),n.target.value,!0),r=o.view();n.target.value="";const s={id:r.id,user:r.user,date:r.date,text:r.text};r.text&&(document.querySelector(".scrollBar").appendChild(r.newMess),document.querySelector(".scrollBar").lastElementChild.scrollIntoView({block:"end"}),e.send(JSON.stringify({type:"newMsg",data:s})))}))},e.close=()=>{console.log("connection is closed")}}()))):n(Error("Что-то пошло не так, попробуйте еще раз."))}))}},a.onclose=()=>{console.log("loading data...")}})).then((e=>{e()}),(e=>{alert(e),window.location.reload()}))}()}))})();